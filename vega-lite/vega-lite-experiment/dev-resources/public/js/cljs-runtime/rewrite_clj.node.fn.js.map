{"version":3,"sources":["rewrite_clj/node/fn.cljs"],"mappings":"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","names":["rewrite-clj.node.fn/construct-fn","syms","vararg","body","cljs.core/List","cljs.core/vec","cljs.core.concat","rewrite-clj.node.fn/sym-index","n","cljs.core._EQ_","cljs.core/re-matches","js/parseInt","js/Error","rewrite-clj.node.fn/symbol->gensym","sym-seq","vararg?","max-n","sym","cljs.core/Symbol","nm","cljs.core/name","i","cljs.core.subs","cljs.core.swap_BANG_","cljs.core/max","cljs.core.nth","rewrite-clj.node.fn/fn-walk","form","iter__4529__auto__","s__45999","cljs.core/LazySeq","temp__5735__auto__","cljs.core/seq","cljs.core/chunked-seq?","c__4527__auto__","size__4528__auto__","cljs.core/count","b__46001","cljs.core/chunk-buffer","i__46000","cljs.core/-nth","cljs.core/chunk-append","cljs.core/chunk-cons","cljs.core/chunk","iter__45998","cljs.core/chunk-rest","cljs.core/first","cljs.core/cons","cljs.core/rest","cljs.core.range","base","s","cljs.core.gensym","cljs.core.symbol","cljs.core.atom","p1__45996#","clojure.walk/prewalk","or__4126__auto__","cljs.core/deref","cljs.core.take","this__4380__auto__","k__4381__auto__","this__4382__auto__","k46013","else__4383__auto__","G__46017","cljs.core/Keyword","children","cljs.core.get","__extmap","this__4399__auto__","f__4400__auto__","init__4401__auto__","cljs.core.reduce","ret__4402__auto__","p__46018","vec__46019","k__4403__auto__","v__4404__auto__","this__4394__auto__","writer__4395__auto__","opts__4396__auto__","pr-pair__4397__auto__","keyval__4398__auto__","cljs.core/pr-sequential-writer","cljs.core/PersistentVector","G__46012","cljs.core/RecordIter","cljs.core/-iterator","cljs.core/nil-iter","this__4378__auto__","__meta","this__4375__auto__","__hash","this__4384__auto__","this__4376__auto__","h__4238__auto__","coll__4377__auto__","cljs.core/hash-unordered-coll","this46014","other46015","cljs.core/PROTOCOL_SENTINEL","this__4389__auto__","k__4390__auto__","cljs.core/contains?","cljs.core.dissoc","cljs.core/-with-meta","cljs.core.into","cljs.core/not-empty","this__4387__auto__","k__4388__auto__","pred__46027","cljs.core/keyword-identical?","expr__46028","cljs.core.assoc","this__4392__auto__","cljs.core/MapEntry","this__4379__auto__","this__4385__auto__","entry__4386__auto__","cljs.core/vector?","cljs.core/-conj","rewrite-clj.node.fn/FnNode","this__4423__auto__","writer__4424__auto__","cljs.core/-write","G__46016","extmap__4419__auto__","G__46030","cljs.core/record?","rewrite-clj.node.fn/->FnNode","rewrite-clj.node.fn/map->FnNode","_","rewrite-clj.node.protocols/sexprs","rewrite-clj.node.protocols/sum-lengths","rewrite-clj.node.protocols/concat-strings","this","children'","rewrite-clj.node.fn/fn-node","cljs.core/chunk-first"],"sourcesContent":["(ns ^:no-doc rewrite-clj.node.fn\n  (:require [rewrite-clj.node.protocols :as node]\n            [clojure.walk :as w]))\n\n;; ## Conversion\n\n(defn- construct-fn\n  \"Construct function form.\"\n  [syms vararg body]\n  (list\n    'fn*\n    (vec\n      (concat\n        syms\n        (if vararg\n          (list '& vararg))))\n    body))\n\n(defn- sym-index\n  \"Get index based on the substring following the parameter's `%`.\n   Zero means vararg.\"\n  [n]\n  (cond (= n \"&\") 0\n        (= n \"\") 1\n        (re-matches #\"\\d+\" n) (js/parseInt n)\n        :else (throw (js/Error. \"arg literal must be %, %& or %integer.\"))))\n\n;; TODO: No promises available\n(defn- symbol->gensym\n  \"If symbol starting with `%`, convert to respective gensym.\"\n  [sym-seq vararg? max-n sym]\n  (if (symbol? sym)\n    (let [nm (name sym)]\n      (if (= (.indexOf nm \"%\") 0)\n        (let [i (sym-index (subs nm 1))]\n;;           (if (and (= i 0) (not (realized? vararg?)))\n;;             (deliver vararg? true))\n          (swap! max-n max i)\n          (nth sym-seq i))))))\n\n;; TODO: No promises available\n(defn- fn-walk\n  \"Walk the form and create an expand function form.\"\n  [form]\n  (let [syms (for [i (range)\n                   :let [base (if (= i 0)\n                                \"rest__\"\n                                (str \"p\" i \"__\"))\n                         s (name (gensym base))]]\n               (symbol (str s \"#\")))\n        vararg? false ;(promise)\n        max-n (atom 0)\n        body (w/prewalk\n               #(or (symbol->gensym syms vararg? max-n %) %)\n               form)]\n    (construct-fn\n      (take @max-n (rest syms))\n      nil\n;;       (if (deref vararg? 0 nil)\n;;         (first syms))\n      body)))\n\n;; ## Node\n\n(defrecord FnNode [children]\n  node/Node\n  (tag [_] :fn)\n  (printable-only? [_]\n    false)\n  (sexpr [_]\n    (fn-walk (node/sexprs children)))\n  (length [_]\n    (+ 3 (node/sum-lengths children)))\n  (string [_]\n    (str \"#(\" (node/concat-strings children) \")\"))\n\n  node/InnerNode\n  (inner? [_]\n    true)\n  (children [_]\n    children)\n  (replace-children [this children']\n    (assoc this :children children'))\n\n  Object\n  (toString [this]\n    (node/string this)))\n\n;; TODO\n;(node/make-printable! FnNode)\n\n;; ## Constructor\n\n(defn fn-node\n  \"Create node representing an anonymous function.\"\n  [children]\n  (->FnNode children))\n"]}