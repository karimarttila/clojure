shadow$provide.module$node_modules$vega_transforms$build$vega_transforms=function(global$jscomp$0,require,module,exports$jscomp$0){(function(global,factory){"object"===typeof exports$jscomp$0&&"undefined"!==typeof module?factory(exports$jscomp$0,require("module$node_modules$vega_util$build$vega_util"),require("module$node_modules$vega_dataflow$build$vega_dataflow"),require("module$node_modules$vega_statistics$build$vega_statistics"),require("module$node_modules$d3_array$dist$d3_array"),require("module$node_modules$vega_time$build$vega_time")):
"function"===typeof define&&define.amd?define("exports vega-util vega-dataflow vega-statistics d3-array vega-time".split(" "),factory):(global="undefined"!==typeof globalThis?globalThis:global||self,factory(global.vega={},global.vega,global.vega,global.vega,global.d3,global.vega))})(this,function(exports,vegaUtil,vegaDataflow,vegaStatistics,d3Array,vegaTime){function multikey(f){return function(x){for(var n=f.length,i=1,k=String(f[0](x));i<n;++i)k+="|"+f[i](x);return k}}function groupkey(fields){return fields&&
fields.length?1===fields.length?fields[0]:multikey(fields):function(){return""}}function measure(key,value){return function(out){return vegaUtil.extend({name:key,out:out||key},base_op,value)}}function compareIndex(a,b){return a.idx-b.idx}function resolve(agg){var map={};agg.forEach(function(a){return map[a.name]=a});var getreqs=function(a){a.req&&a.req.forEach(function(key){map[key]||getreqs(map[key]=AggregateOps[key]())})};agg.forEach(getreqs);return Object.values(map).sort(compareIndex)}function init$jscomp$0(){var $jscomp$this=
this;this.missing=this.valid=0;this._ops.forEach(function(op){return op.init($jscomp$this)})}function add$jscomp$0(v,t){var $jscomp$this=this;null==v||""===v?++this.missing:v===v&&(++this.valid,this._ops.forEach(function(op){return op.add($jscomp$this,v,t)}))}function rem$jscomp$0(v,t){var $jscomp$this=this;null==v||""===v?--this.missing:v===v&&(--this.valid,this._ops.forEach(function(op){return op.rem($jscomp$this,v,t)}))}function set$jscomp$0(t){var $jscomp$this=this;this._out.forEach(function(op){return t[op.out]=
op.value($jscomp$this)});return t}function compileMeasures(agg,field){function ctr(cell){this._ops=ops;this._out=out;this.cell=cell;this.init()}field=field||vegaUtil.identity;var ops=resolve(agg),out=agg.slice().sort(compareIndex);ctr.prototype.init=init$jscomp$0;ctr.prototype.add=add$jscomp$0;ctr.prototype.rem=rem$jscomp$0;ctr.prototype.set=set$jscomp$0;ctr.prototype.get=field;ctr.fields=agg.map(function(op){return op.out});return ctr}function TupleStore(key){this._key=key?vegaUtil.field(key):vegaDataflow.tupleid;
this.reset()}function Aggregate(params){vegaDataflow.Transform.call(this,null,params);this._adds=[];this._mods=[];this._mlen=this._alen=0;this._drop=!0;this._cross=!1;this._dims=[];this._dnames=[];this._measures=[];this._countOnly=!1;this._outputs=this._inputs=this._prev=this._counts=null}function Bin(params){vegaDataflow.Transform.call(this,null,params)}function SortedList(idFunc,source,input){var data=source||[],add=input||[],rem={},cnt=0;return{add:function(t){return add.push(t)},remove:function(t){return rem[idFunc(t)]=
++cnt},size:function(){return data.length},data:function(compare,resort){cnt&&(data=data.filter(function(t){return!rem[idFunc(t)]}),rem={},cnt=0);resort&&compare&&data.sort(compare);add.length&&(data=compare?vegaUtil.merge(compare,data,add.sort(compare)):data.concat(add),add=[]);return data}}}function Collect(params){vegaDataflow.Transform.call(this,[],params)}function Compare(params){vegaDataflow.Operator.call(this,null,update$5,params)}function update$5(_){return this.value&&!_.modified()?this.value:
vegaUtil.compare(_.fields,_.orders)}function CountPattern(params){vegaDataflow.Transform.call(this,null,params)}function Cross(params){vegaDataflow.Transform.call(this,null,params)}function parse(def,data){var func=def["function"];vegaUtil.hasOwnProperty(Distributions,func)||vegaUtil.error("Unknown distribution function: "+func);func=Distributions[func]();for(var name in def)if("field"===name)func.data((def.from||data()).map(def[name]));else if("distributions"===name)func[name](def[name].map(function(_){return parse(_,
data)}));else if("function"===typeof func[name])func[name](def[name]);return func}function Density(params){vegaDataflow.Transform.call(this,null,params)}function source$jscomp$0(pulse){return function(){return pulse.materialize(pulse.SOURCE).source}}function fieldNames(fields,as){return fields?fields.map(function(f,i){return as[i]||vegaUtil.accessorName(f)}):null}function partition$1(data,groupby,field){var groups=[],get=function(f){return f(t)},n;if(null==groupby)groups.push(data.map(field));else{var map=
{};var i=0;for(n=data.length;i<n;++i){var t=data[i];var k=groupby.map(get);var g=map[k];g||(map[k]=g=[],g.dims=k,groups.push(g));g.push(field(t))}}return groups}function DotBin(params){vegaDataflow.Transform.call(this,null,params)}function Expression(params){vegaDataflow.Operator.call(this,null,update$4,params);this.modified(!0)}function update$4(_){var expr=_.expr;return this.value&&!_.modified("expr")?this.value:vegaUtil.accessor(function(datum){return expr(datum,_)},vegaUtil.accessorFields(expr),
vegaUtil.accessorName(expr))}function Extent(params){vegaDataflow.Transform.call(this,[void 0,void 0],params)}function Subflow(pulse,parent){vegaDataflow.Operator.call(this,pulse);this.parent=parent;this.count=0}function Facet(params){vegaDataflow.Transform.call(this,{},params);this._keys=vegaUtil.fastmap();var a=this._targets=[];a.active=0;a.forEach=function(f){for(var i=0,n=a.active;i<n;++i)f(a[i],i,a)}}function Field(params){vegaDataflow.Operator.call(this,null,update$3,params)}function update$3(_){return this.value&&
!_.modified()?this.value:vegaUtil.isArray(_.name)?vegaUtil.array(_.name).map(function(f){return vegaUtil.field(f)}):vegaUtil.field(_.name,_.as)}function Filter(params){vegaDataflow.Transform.call(this,vegaUtil.fastmap(),params)}function Flatten(params){vegaDataflow.Transform.call(this,[],params)}function Fold(params){vegaDataflow.Transform.call(this,[],params)}function Formula(params){vegaDataflow.Transform.call(this,null,params)}function Generate(params){vegaDataflow.Transform.call(this,[],params)}
function Impute(params){vegaDataflow.Transform.call(this,[],params)}function getValue(_){var m=_.method||Methods.value;if(null==Methods[m])vegaUtil.error("Unrecognized imputation method: "+m);else{if(m===Methods.value){var v=void 0!==_.value?_.value:0;return function(){return v}}return Methods[m]}}function getField(_){var f=_.field;return function(t){return t?f(t):NaN}}function partition(data,groupby,key,keyvals){var get=function(f){return f(t)},groups=[];keyvals=keyvals?keyvals.slice():[];var kMap=
{},gMap={},group,n;keyvals.forEach(function(k,i){return kMap[k]=i+1});var i$jscomp$0=0;for(n=data.length;i$jscomp$0<n;++i$jscomp$0){var t=data[i$jscomp$0];var gVals=key(t);var j=kMap[gVals]||(kMap[gVals]=keyvals.push(gVals));var gKey=(gVals=groupby?groupby.map(get):Empty)+"";(group=gMap[gKey])||(group=gMap[gKey]=[],groups.push(group),group.values=gVals);group[j-1]=t}groups.domain=keyvals;return groups}function JoinAggregate(params){Aggregate.call(this,params)}function KDE(params){vegaDataflow.Transform.call(this,
null,params)}function Key(params){vegaDataflow.Operator.call(this,null,update$2,params)}function update$2(_){return this.value&&!_.modified()?this.value:vegaUtil.key(_.fields,_.flat)}function Load(params){vegaDataflow.Transform.call(this,[],params);this._pending=null}function stop$jscomp$0(_){return _.modified("async")&&!(_.modified("values")||_.modified("url")||_.modified("format"))}function output$jscomp$0(op,pulse,data){data.forEach(vegaDataflow.ingest);pulse=pulse.fork(pulse.NO_FIELDS&pulse.NO_SOURCE);
pulse.rem=op.value;op.value=pulse.source=pulse.add=data;op._pending=null;pulse.rem.length&&pulse.clean(!0);return pulse}function Lookup(params){vegaDataflow.Transform.call(this,{},params)}function MultiExtent(params){vegaDataflow.Operator.call(this,null,update$1,params)}function update$1(_){if(this.value&&!_.modified())return this.value;_=_.extents;var n=_.length,min=Infinity,max=-Infinity,i;for(i=0;i<n;++i){var e=_[i];e[0]<min&&(min=e[0]);e[1]>max&&(max=e[1])}return[min,max]}function MultiValues(params){vegaDataflow.Operator.call(this,
null,update$jscomp$0,params)}function update$jscomp$0(_$jscomp$0){return this.value&&!_$jscomp$0.modified()?this.value:_$jscomp$0.values.reduce(function(data,_){return data.concat(_)},[])}function Params(params){vegaDataflow.Transform.call(this,null,params)}function Pivot(params){Aggregate.call(this,params)}function aggregateParams(_,pulse){var key=_.field,value=_.value,op=("count"===_.op?"__count__":_.op)||"sum",fields=vegaUtil.accessorFields(key).concat(vegaUtil.accessorFields(value)),keys=pivotKeys(key,
_.limit||0,pulse);pulse.changed()&&_.set("__pivot__",null,null,!0);return{key:_.key,groupby:_.groupby,ops:keys.map(function(){return op}),fields:keys.map(function(k){return get$jscomp$0(k,key,value,fields)}),as:keys.map(function(k){return k+""}),modified:_.modified.bind(_)}}function get$jscomp$0(k,key,value,fields){return vegaUtil.accessor(function(d){return key(d)===k?value(d):NaN},fields,k+"")}function pivotKeys(key,limit,pulse){var map={},list=[];pulse.visit(pulse.SOURCE,function(t){t=key(t);map[t]||
(map[t]=1,list.push(t))});list.sort(vegaUtil.ascending);return limit?list.slice(0,limit):list}function PreFacet(params){Facet.call(this,params)}function Project(params){vegaDataflow.Transform.call(this,null,params)}function Proxy(params){vegaDataflow.Transform.call(this,null,params)}function Quantile(params){vegaDataflow.Transform.call(this,null,params)}function Relay(params){vegaDataflow.Transform.call(this,null,params)}function Sample(params){vegaDataflow.Transform.call(this,[],params);this.count=
0}function Sequence(params){vegaDataflow.Transform.call(this,null,params)}function Sieve(params){vegaDataflow.Transform.call(this,null,params);this.modified(!0)}function TimeUnit(params){vegaDataflow.Transform.call(this,null,params)}function TupleIndex(params){vegaDataflow.Transform.call(this,vegaUtil.fastmap(),params)}function Values(params){vegaDataflow.Transform.call(this,null,params)}function WindowOp(op,field,param,as){var fn=WindowOps[op](field,param);return{init:fn.init||vegaUtil.zero,update:function(w,
t){t[as]=fn.next(w)}}}function WindowState(_$jscomp$0){function visitInputs(f){vegaUtil.array(vegaUtil.accessorFields(f)).forEach(function(_){return inputs[_]=1})}var ops=vegaUtil.array(_$jscomp$0.ops),fields=vegaUtil.array(_$jscomp$0.fields),params=vegaUtil.array(_$jscomp$0.params),as=vegaUtil.array(_$jscomp$0.as),outputs=this.outputs=[],windows=this.windows=[],inputs={},map={},counts=[],measures=[],countOnly=!0;visitInputs(_$jscomp$0.sort);ops.forEach(function(op,i){var field=fields[i],mname=vegaUtil.accessorName(field),
name=as[i]||op+(mname?"_"+mname:"");visitInputs(field);outputs.push(name);vegaUtil.hasOwnProperty(WindowOps,op)?windows.push(WindowOp(op,fields[i],params[i],name)):(null==field&&"count"!==op&&vegaUtil.error("Null aggregate field specified."),"count"===op?counts.push(name):(countOnly=!1,i=map[mname],i||(i=map[mname]=[],i.field=field,measures.push(i)),i.push(AggregateOps[op](name))))});if(counts.length||measures.length)this.cell=cell(measures,counts,countOnly);this.inputs=Object.keys(inputs)}function cell(measures,
counts,countOnly){measures=measures.map(function(m){return compileMeasures(m,m.field)});var cell={num:0,agg:null,store:!1,count:counts};if(!countOnly)for(var n$jscomp$0=measures.length,a=cell.agg=Array(n$jscomp$0),i$jscomp$0=0;i$jscomp$0<n$jscomp$0;++i$jscomp$0)a[i$jscomp$0]=new measures[i$jscomp$0](cell);if(cell.store)var store=cell.data=new TupleStore;cell.add=function(t){cell.num+=1;if(!countOnly){store&&store.add(t);for(var i$664=0;i$664<n$jscomp$0;++i$664)a[i$664].add(a[i$664].get(t),t)}};cell.rem=
function(t){--cell.num;if(!countOnly){store&&store.rem(t);for(var i$665=0;i$665<n$jscomp$0;++i$665)a[i$665].rem(a[i$665].get(t),t)}};cell.set=function(t){var n;store&&store.values();var i=0;for(n=counts.length;i<n;++i)t[counts[i]]=cell.num;if(!countOnly)for(i=0,n=a.length;i<n;++i)a[i].set(t)};cell.init=function(){cell.num=0;store&&store.reset();for(var i$666=0;i$666<n$jscomp$0;++i$666)a[i$666].init()};return cell}function Window(params){vegaDataflow.Transform.call(this,{},params);this._mlen=0;this._mods=
[]}function processPartition(list,state,cmp,_){var sort=_.sort,range=sort&&!_.ignorePeers;_=_.frame||[null,0];list=list.data(cmp);cmp=list.length;var b=range?d3Array.bisector(sort):null;sort={i0:0,i1:0,p0:0,p1:0,index:0,data:list,compare:sort||vegaUtil.constant(-1)};state.init();for(var i=0;i<cmp;++i){var i$jscomp$0=i;sort.p0=sort.i0;sort.p1=sort.i1;sort.i0=null==_[0]?0:Math.max(0,i$jscomp$0-Math.abs(_[0]));sort.i1=null==_[1]?cmp:Math.min(cmp,i$jscomp$0+Math.abs(_[1])+1);sort.index=i$jscomp$0;if(range){i$jscomp$0=
sort.i0;var r1=sort.i1-1,c=sort.compare,d=sort.data,n=d.length-1;0<i$jscomp$0&&!c(d[i$jscomp$0],d[i$jscomp$0-1])&&(sort.i0=b.left(d,d[i$jscomp$0]));r1<n&&!c(d[r1],d[r1+1])&&(sort.i1=b.right(d,d[r1]))}state.update(sort,list[i])}}var noop=function(){},base_op={init:noop,add:noop,rem:noop,idx:0},AggregateOps={values:{init:function(m){return m.cell.store=!0},value:function(m){return m.cell.data.values()},idx:-1},count:{value:function(m){return m.cell.num}},__count__:{value:function(m){return m.missing+
m.valid}},missing:{value:function(m){return m.missing}},valid:{value:function(m){return m.valid}},sum:{init:function(m){return m.sum=0},value:function(m){return m.sum},add:function(m,v){return m.sum+=+v},rem:function(m,v){return m.sum-=v}},product:{init:function(m){return m.product=1},value:function(m){return m.valid?m.product:void 0},add:function(m,v){return m.product*=v},rem:function(m,v){return m.product/=v}},mean:{init:function(m){return m.mean=0},value:function(m){return m.valid?m.mean:void 0},
add:function(m,v){return m.mean_d=v-m.mean,m.mean+=m.mean_d/m.valid},rem:function(m,v){return m.mean_d=v-m.mean,m.mean-=m.valid?m.mean_d/m.valid:m.mean}},average:{value:function(m){return m.valid?m.mean:void 0},req:["mean"],idx:1},variance:{init:function(m){return m.dev=0},value:function(m){return 1<m.valid?m.dev/(m.valid-1):void 0},add:function(m,v){return m.dev+=m.mean_d*(v-m.mean)},rem:function(m,v){return m.dev-=m.mean_d*(v-m.mean)},req:["mean"],idx:1},variancep:{value:function(m){return 1<m.valid?
m.dev/m.valid:void 0},req:["variance"],idx:2},stdev:{value:function(m){return 1<m.valid?Math.sqrt(m.dev/(m.valid-1)):void 0},req:["variance"],idx:2},stdevp:{value:function(m){return 1<m.valid?Math.sqrt(m.dev/m.valid):void 0},req:["variance"],idx:2},stderr:{value:function(m){return 1<m.valid?Math.sqrt(m.dev/(m.valid*(m.valid-1))):void 0},req:["variance"],idx:2},distinct:{value:function(m){return m.cell.data.distinct(m.get)},req:["values"],idx:3},ci0:{value:function(m){return m.cell.data.ci0(m.get)},
req:["values"],idx:3},ci1:{value:function(m){return m.cell.data.ci1(m.get)},req:["values"],idx:3},median:{value:function(m){return m.cell.data.q2(m.get)},req:["values"],idx:3},q1:{value:function(m){return m.cell.data.q1(m.get)},req:["values"],idx:3},q3:{value:function(m){return m.cell.data.q3(m.get)},req:["values"],idx:3},min:{init:function(m){return m.min=void 0},value:function(m){return m.min=Number.isNaN(m.min)?m.cell.data.min(m.get):m.min},add:function(m,v){if(v<m.min||void 0===m.min)m.min=v},
rem:function(m,v){v<=m.min&&(m.min=NaN)},req:["values"],idx:4},max:{init:function(m){return m.max=void 0},value:function(m){return m.max=Number.isNaN(m.max)?m.cell.data.max(m.get):m.max},add:function(m,v){if(v>m.max||void 0===m.max)m.max=v},rem:function(m,v){v>=m.max&&(m.max=NaN)},req:["values"],idx:4},argmin:{init:function(m){return m.argmin=void 0},value:function(m){return m.argmin||m.cell.data.argmin(m.get)},add:function(m,v,t){v<m.min&&(m.argmin=t)},rem:function(m,v){v<=m.min&&(m.argmin=void 0)},
req:["min","values"],idx:3},argmax:{init:function(m){return m.argmax=void 0},value:function(m){return m.argmax||m.cell.data.argmax(m.get)},add:function(m,v,t){v>m.max&&(m.argmax=t)},rem:function(m,v){v>=m.max&&(m.argmax=void 0)},req:["max","values"],idx:3}};noop=Object.keys(AggregateOps);noop.forEach(function(key){AggregateOps[key]=measure(key,AggregateOps[key])});var prototype$1=TupleStore.prototype;prototype$1.reset=function(){this._add=[];this._rem=[];this._q=this._get=this._ext=null};prototype$1.add=
function(v){this._add.push(v)};prototype$1.rem=function(v){this._rem.push(v)};prototype$1.values=function(){this._get=null;if(0===this._rem.length)return this._add;var a=this._add,r=this._rem,k=this._key,n=a.length,m=r.length,x=Array(n-m),map={},i,v;for(i=0;i<m;++i)map[k(r[i])]=1;for(r=i=0;i<n;++i)map[k(v=a[i])]?map[k(v)]=0:x[r++]=v;this._rem=[];return this._add=x};prototype$1.distinct=function(get){for(var v=this.values(),map={},n=v.length,count=0,s;0<=--n;)s=get(v[n])+"",vegaUtil.hasOwnProperty(map,
s)||(map[s]=1,++count);return count};prototype$1.extent=function(get){if(this._get!==get||!this._ext){var v=this.values(),i=vegaUtil.extentIndex(v,get);this._ext=[v[i[0]],v[i[1]]];this._get=get}return this._ext};prototype$1.argmin=function(get){return this.extent(get)[0]||{}};prototype$1.argmax=function(get){return this.extent(get)[1]||{}};prototype$1.min=function(get){var m=this.extent(get)[0];return null!=m?get(m):void 0};prototype$1.max=function(get){var m=this.extent(get)[1];return null!=m?get(m):
void 0};prototype$1.quartile=function(get){this._get===get&&this._q||(this._q=vegaStatistics.quartiles(this.values(),get),this._get=get);return this._q};prototype$1.q1=function(get){return this.quartile(get)[0]};prototype$1.q2=function(get){return this.quartile(get)[1]};prototype$1.q3=function(get){return this.quartile(get)[2]};prototype$1.ci=function(get){this._get===get&&this._ci||(this._ci=vegaStatistics.bootstrapCI(this.values(),1E3,.05,get),this._get=get);return this._ci};prototype$1.ci0=function(get){return this.ci(get)[0]};
prototype$1.ci1=function(get){return this.ci(get)[1]};Aggregate.Definition={type:"Aggregate",metadata:{generates:!0,changes:!0},params:[{name:"groupby",type:"field",array:!0},{name:"ops",type:"enum",array:!0,values:noop},{name:"fields",type:"field","null":!0,array:!0},{name:"as",type:"string","null":!0,array:!0},{name:"drop",type:"boolean","default":!0},{name:"cross",type:"boolean","default":!1},{name:"key",type:"field"}]};vegaUtil.inherits(Aggregate,vegaDataflow.Transform,{transform:function(_,pulse){var $jscomp$this=
this,aggr=this,out=pulse.fork(pulse.NO_SOURCE|pulse.NO_FIELDS),mod=_.modified();aggr.stamp=out.stamp;aggr.value&&(mod||pulse.modified(aggr._inputs,!0))?(aggr._prev=aggr.value,aggr.value=mod?aggr.init(_):{},pulse.visit(pulse.SOURCE,function(t){return aggr.add(t)})):(aggr.value=aggr.value||aggr.init(_),pulse.visit(pulse.REM,function(t){return aggr.rem(t)}),pulse.visit(pulse.ADD,function(t){return aggr.add(t)}));out.modifies(aggr._outputs);aggr._drop=!1!==_.drop;_.cross&&1<aggr._dims.length&&(aggr._drop=
!1,aggr.cross());pulse.clean()&&aggr._drop&&out.clean(!0).runAfter(function(){return $jscomp$this.clean()});return aggr.changes(out)},cross:function(){function collect(cells){var key,i,v;for(key in cells){var t=cells[key].tuple;for(i=0;i<n;++i)vals[i][v=t[dims[i]]]=v}}function generate(base,tuple,index){var name=dims[index],v=vals[index++],k;for(k in v){var key=base?base+"|"+k:k;tuple[name]=v[k];index<n?generate(key,tuple,index):curr[key]||aggr.cell(key,tuple)}}var aggr=this,curr=aggr.value,dims=
aggr._dnames,vals=dims.map(function(){return{}}),n=dims.length;collect(aggr._prev);collect(curr);generate("",{},0)},init:function(_){function inputVisit(get){get=vegaUtil.array(vegaUtil.accessorFields(get));for(var n=get.length,i=0,f;i<n;++i)inputMap[f=get[i]]||(inputMap[f]=1,inputs.push(f))}var inputs=this._inputs=[],outputs=this._outputs=[],inputMap={};this._dims=vegaUtil.array(_.groupby);this._dnames=this._dims.map(function(d){var dname=vegaUtil.accessorName(d);inputVisit(d);outputs.push(dname);
return dname});this.cellkey=_.key?_.key:groupkey(this._dims);this._countOnly=!0;this._counts=[];this._measures=[];var fields=_.fields||[null],ops=_.ops||["count"];_=_.as||[];var n$jscomp$0=fields.length,map={},i$jscomp$0;n$jscomp$0!==ops.length&&vegaUtil.error("Unmatched number of fields and aggregate ops.");for(i$jscomp$0=0;i$jscomp$0<n$jscomp$0;++i$jscomp$0){var field=fields[i$jscomp$0];var op=ops[i$jscomp$0];null==field&&"count"!==op&&vegaUtil.error("Null aggregate field specified.");var mname=
vegaUtil.accessorName(field);var outname=_[i$jscomp$0]||op+(mname?"_"+mname:"");outputs.push(outname);if("count"===op)this._counts.push(outname);else{var m$jscomp$0=map[mname];m$jscomp$0||(inputVisit(field),m$jscomp$0=map[mname]=[],m$jscomp$0.field=field,this._measures.push(m$jscomp$0));"count"!==op&&(this._countOnly=!1);m$jscomp$0.push(AggregateOps[op](outname))}}this._measures=this._measures.map(function(m){return compileMeasures(m,m.field)});return{}},cellkey:groupkey(),cell:function(key,t){var cell=
this.value[key];cell?0===cell.num&&this._drop&&cell.stamp<this.stamp?(cell.stamp=this.stamp,this._adds[this._alen++]=cell):cell.stamp<this.stamp&&(cell.stamp=this.stamp,this._mods[this._mlen++]=cell):(cell=this.value[key]=this.newcell(key,t),this._adds[this._alen++]=cell);return cell},newcell:function(key,t){key={key:key,num:0,agg:null,tuple:this.newtuple(t,this._prev&&this._prev[key]),stamp:this.stamp,store:!1};if(!this._countOnly){t=this._measures;var n=t.length;key.agg=Array(n);for(var i=0;i<n;++i)key.agg[i]=
new t[i](key)}key.store&&(key.data=new TupleStore);return key},newtuple:function(t,p){for(var names=this._dnames,dims=this._dims,n=dims.length,x={},i=0;i<n;++i)x[names[i]]=dims[i](t);return p?vegaDataflow.replace(p.tuple,x):vegaDataflow.ingest(x)},clean:function(){var cells=this.value,key;for(key in cells)0===cells[key].num&&delete cells[key]},add:function(t){var key=this.cellkey(t);key=this.cell(key,t);key.num+=1;if(!this._countOnly){key.store&&key.data.add(t);key=key.agg;for(var i=0,n=key.length;i<
n;++i)key[i].add(key[i].get(t),t)}},rem:function(t){var key=this.cellkey(t);key=this.cell(key,t);--key.num;if(!this._countOnly){key.store&&key.data.rem(t);key=key.agg;for(var i=0,n=key.length;i<n;++i)key[i].rem(key[i].get(t),t)}},celltuple:function(cell){var tuple=cell.tuple,counts=this._counts;cell.store&&cell.data.values();for(var i=0,n=counts.length;i<n;++i)tuple[counts[i]]=cell.num;if(!this._countOnly)for(cell=cell.agg,counts=0,i=cell.length;counts<i;++counts)cell[counts].set(tuple);return tuple},
changes:function(out){var adds=this._adds,mods=this._mods,prev=this._prev,drop=this._drop,add=out.add,rem=out.rem,mod=out.mod,key;if(prev)for(key in prev){var cell=prev[key];drop&&!cell.num||rem.push(cell.tuple)}prev=0;for(key=this._alen;prev<key;++prev)add.push(this.celltuple(adds[prev])),adds[prev]=null;prev=0;for(key=this._mlen;prev<key;++prev)cell=mods[prev],(0===cell.num&&drop?rem:mod).push(this.celltuple(cell)),mods[prev]=null;this._alen=this._mlen=0;this._prev=null;return out}});Bin.Definition=
{type:"Bin",metadata:{modifies:!0},params:[{name:"field",type:"field",required:!0},{name:"interval",type:"boolean","default":!0},{name:"anchor",type:"number"},{name:"maxbins",type:"number","default":20},{name:"base",type:"number","default":10},{name:"divide",type:"number",array:!0,"default":[5,2]},{name:"extent",type:"number",array:!0,length:2,required:!0},{name:"span",type:"number"},{name:"step",type:"number"},{name:"steps",type:"number",array:!0},{name:"minstep",type:"number","default":0},{name:"nice",
type:"boolean","default":!0},{name:"name",type:"string"},{name:"as",type:"string",array:!0,length:2,"default":["bin0","bin1"]}]};vegaUtil.inherits(Bin,vegaDataflow.Transform,{transform:function(_,pulse){var band=!1!==_.interval,bins=this._bins(_),start=bins.start,step=bins.step,as=_.as||["bin0","bin1"],b0=as[0],b1=as[1];_.modified()?(pulse=pulse.reflow(!0),_=pulse.SOURCE):_=pulse.modified(vegaUtil.accessorFields(_.field))?pulse.ADD_MOD:pulse.ADD;pulse.visit(_,band?function(t){var v=bins(t);t[b0]=
v;t[b1]=null==v?null:start+step*(1+(v-start)/step)}:function(t){return t[b0]=bins(t)});return pulse.modifies(band?as:b0)},_bins:function(_){if(this.value&&!_.modified())return this.value;var field=_.field,bins=vegaStatistics.bin(_),step=bins.step,start=bins.start,stop=start+Math.ceil((bins.stop-start)/step)*step,a;null!=(a=_.anchor)&&(a-=start+step*Math.floor((a-start)/step),start+=a,stop+=a);a=function(t){t=vegaUtil.toNumber(field(t));return null==t?null:t<start?-Infinity:t>stop?Infinity:(t=Math.max(start,
Math.min(t,stop-step)),start+step*Math.floor(1E-14+(t-start)/step))};a.start=start;a.stop=bins.stop;a.step=step;return this.value=vegaUtil.accessor(a,vegaUtil.accessorFields(field),_.name||"bin_"+vegaUtil.accessorName(field))}});Collect.Definition={type:"Collect",metadata:{source:!0},params:[{name:"sort",type:"compare"}]};vegaUtil.inherits(Collect,vegaDataflow.Transform,{transform:function(_,pulse){var out=pulse.fork(pulse.ALL),list=SortedList(vegaDataflow.tupleid,this.value,out.materialize(out.ADD).add),
sort=_.sort;_=pulse.changed()||sort&&(_.modified("sort")||pulse.modified(sort.fields));out.visit(out.REM,list.remove);this.modified(_);this.value=out.source=list.data(vegaDataflow.stableCompare(sort),_);pulse.source&&pulse.source.root&&(this.value.root=pulse.source.root);return out}});vegaUtil.inherits(Compare,vegaDataflow.Operator);CountPattern.Definition={type:"CountPattern",metadata:{generates:!0,changes:!0},params:[{name:"field",type:"field",required:!0},{name:"case",type:"enum",values:["upper",
"lower","mixed"],"default":"mixed"},{name:"pattern",type:"string","default":'[\\w"]+'},{name:"stopwords",type:"string","default":""},{name:"as",type:"string",array:!0,length:2,"default":["text","count"]}]};vegaUtil.inherits(CountPattern,vegaDataflow.Transform,{transform:function(_,pulse){var process=function(update){return function(tuple){tuple=get(tuple);switch(_.case){case "upper":tuple=tuple.toUpperCase();break;case "lower":tuple=tuple.toLowerCase()}tuple=tuple.match(match)||[];for(var t,i=0,n=
tuple.length;i<n;++i)stop.test(t=tuple[i])||update(t)}},init=this._parameterCheck(_,pulse),counts=this._counts,match=this._match,stop=this._stop,get=_.field,as=_.as||["text","count"],add=process(function(t){return counts[t]=1+(counts[t]||0)});process=process(function(t){return--counts[t]});init?pulse.visit(pulse.SOURCE,add):(pulse.visit(pulse.ADD,add),pulse.visit(pulse.REM,process));return this._finish(pulse,as)},_parameterCheck:function(_,pulse){var init=!1;if(_.modified("stopwords")||!this._stop)this._stop=
new RegExp("^"+(_.stopwords||"")+"$","i"),init=!0;if(_.modified("pattern")||!this._match)this._match=new RegExp(_.pattern||"[\\w']+","g"),init=!0;if(_.modified("field")||pulse.modified(_.field.fields))init=!0;init&&(this._counts={});return init},_finish:function(pulse,as){var counts=this._counts,tuples=this._tuples||(this._tuples={}),text=as[0],count=as[1];pulse=pulse.fork(pulse.NO_SOURCE|pulse.NO_FIELDS);var w;for(w in counts){var t=tuples[w];var c=counts[w]||0;!t&&c?(tuples[w]=t=vegaDataflow.ingest({}),
t[text]=w,t[count]=c,pulse.add.push(t)):0===c?(t&&pulse.rem.push(t),counts[w]=null,tuples[w]=null):t[count]!==c&&(t[count]=c,pulse.mod.push(t))}return pulse.modifies(as)}});Cross.Definition={type:"Cross",metadata:{generates:!0},params:[{name:"filter",type:"expr"},{name:"as",type:"string",array:!0,length:2,"default":["a","b"]}]};vegaUtil.inherits(Cross,vegaDataflow.Transform,{transform:function(_,pulse){var out=pulse.fork(pulse.NO_SOURCE),as=_.as||["a","b"],a=as[0],b=as[1],reset=!this.value||pulse.changed(pulse.ADD_REM)||
_.modified("as")||_.modified("filter"),data=this.value;if(reset){data&&(out.rem=data);pulse=data=pulse.materialize(pulse.SOURCE).source;_=_.filter||vegaUtil.truthy;reset=[];data={};for(var n=pulse.length,i=0,j,left;i<n;++i)for(data[a]=left=pulse[i],j=0;j<n;++j)data[b]=pulse[j],_(data)&&(reset.push(vegaDataflow.ingest(data)),data={},data[a]=left);out.add=this.value=reset}else out.mod=data;out.source=this.value;return out.modifies(as)}});var Distributions={kde:vegaStatistics.randomKDE,mixture:vegaStatistics.randomMixture,
normal:vegaStatistics.randomNormal,lognormal:vegaStatistics.randomLogNormal,uniform:vegaStatistics.randomUniform};prototype$1=[{key:{"function":"normal"},params:[{name:"mean",type:"number","default":0},{name:"stdev",type:"number","default":1}]},{key:{"function":"lognormal"},params:[{name:"mean",type:"number","default":0},{name:"stdev",type:"number","default":1}]},{key:{"function":"uniform"},params:[{name:"min",type:"number","default":0},{name:"max",type:"number","default":1}]},{key:{"function":"kde"},
params:[{name:"field",type:"field",required:!0},{name:"from",type:"data"},{name:"bandwidth",type:"number","default":0}]}];Density.Definition={type:"Density",metadata:{generates:!0},params:[{name:"extent",type:"number",array:!0,length:2},{name:"steps",type:"number"},{name:"minsteps",type:"number","default":25},{name:"maxsteps",type:"number","default":200},{name:"method",type:"string","default":"pdf",values:["pdf","cdf"]},{name:"distribution",type:"param",params:prototype$1.concat({key:{"function":"mixture"},
params:[{name:"distributions",type:"param",array:!0,params:prototype$1},{name:"weights",type:"number",array:!0}]})},{name:"as",type:"string",array:!0,"default":["value","density"]}]};vegaUtil.inherits(Density,vegaDataflow.Transform,{transform:function(_,pulse){var out=pulse.fork(pulse.NO_SOURCE|pulse.NO_FIELDS);if(!this.value||pulse.changed()||_.modified()){var dist=parse(_.distribution,source$jscomp$0(pulse));pulse=_.steps||_.minsteps||25;var maxsteps=_.steps||_.maxsteps||200,method=_.method||"pdf";
"pdf"!==method&&"cdf"!==method&&vegaUtil.error("Invalid density method: "+method);_.extent||dist.data||vegaUtil.error("Missing density extent parameter.");method=dist[method];var as=_.as||["value","density"];_=_.extent||vegaUtil.extent(dist.data());_=vegaStatistics.sampleCurve(method,_,pulse,maxsteps).map(function(v){var tuple={};tuple[as[0]]=v[0];tuple[as[1]]=v[1];return vegaDataflow.ingest(tuple)});this.value&&(out.rem=this.value);this.value=out.add=out.source=_}return out}});DotBin.Definition=
{type:"DotBin",metadata:{modifies:!0},params:[{name:"field",type:"field",required:!0},{name:"groupby",type:"field",array:!0},{name:"step",type:"number"},{name:"smooth",type:"boolean","default":!1},{name:"as",type:"string","default":"bin"}]};vegaUtil.inherits(DotBin,vegaDataflow.Transform,{transform:function(_,pulse){if(this.value&&!_.modified()&&!pulse.changed())return pulse;var source=pulse.materialize(pulse.SOURCE).source,groups=partition$1(pulse.source,_.groupby,vegaUtil.identity),smooth=_.smooth||
!1,field=_.field;source=_.step||vegaUtil.span(vegaUtil.extent(source,field))/30;var sort=vegaDataflow.stableCompare(function(a,b){return field(a)-field(b)});_=_.as||"bin";for(var n=groups.length,min=Infinity,max=-Infinity,i=0,j;i<n;++i){var g=groups[i].sort(sort);j=-1;for(var $jscomp$iter$309=$jscomp.makeIterator(vegaStatistics.dotbin(g,source,smooth,field)),$jscomp$key$v=$jscomp$iter$309.next();!$jscomp$key$v.done;$jscomp$key$v=$jscomp$iter$309.next())$jscomp$key$v=$jscomp$key$v.value,$jscomp$key$v<
min&&(min=$jscomp$key$v),$jscomp$key$v>max&&(max=$jscomp$key$v),g[++j][_]=$jscomp$key$v}this.value={start:min,stop:max,step:source};return pulse.reflow(!0).modifies(_)}});vegaUtil.inherits(Expression,vegaDataflow.Operator);Extent.Definition={type:"Extent",metadata:{},params:[{name:"field",type:"field",required:!0}]};vegaUtil.inherits(Extent,vegaDataflow.Transform,{transform:function(_,pulse){var extent=this.value,field=_.field;_=pulse.changed()||pulse.modified(field.fields)||_.modified("field");var min=
extent[0],max=extent[1];if(_||null==min)min=Infinity,max=-Infinity;pulse.visit(_?pulse.SOURCE:pulse.ADD,function(t){t=vegaUtil.toNumber(field(t));null!=t&&(t<min&&(min=t),t>max&&(max=t))});Number.isFinite(min)&&Number.isFinite(max)||((extent=vegaUtil.accessorName(field))&&(extent=' for field "'+extent+'"'),pulse.dataflow.warn("Infinite extent"+extent+": ["+min+", "+max+"]"),min=max=void 0);this.value=[min,max]}});vegaUtil.inherits(Subflow,vegaDataflow.Operator,{connect:function(target){this.detachSubflow=
target.detachSubflow;this.targets().add(target);return target.source=this},add:function(t){this.count+=1;this.value.add.push(t)},rem:function(t){--this.count;this.value.rem.push(t)},mod:function(t){this.value.mod.push(t)},init:function(pulse){this.value.init(pulse,pulse.NO_SOURCE)},evaluate:function(){return this.value}});vegaUtil.inherits(Facet,vegaDataflow.Transform,{activate:function(flow){this._targets[this._targets.active++]=flow},subflow:function(key,flow,pulse,parent){var flows=this.value,
sf=vegaUtil.hasOwnProperty(flows,key)&&flows[key];if(sf)sf.value.stamp<pulse.stamp&&(sf.init(pulse),this.activate(sf));else{var p=parent||(p=this._group[key])&&p.tuple;parent=pulse.dataflow;sf=new Subflow(pulse.fork(pulse.NO_SOURCE),this);parent.add(sf).connect(flow(parent,key,p));flows[key]=sf;this.activate(sf)}return sf},clean:function(){var flows=this.value,detached=0,key;for(key in flows)if(0===flows[key].count){var detach=flows[key].detachSubflow;detach&&detach();delete flows[key];++detached}detached&&
(flows=this._targets.filter(function(sf){return sf&&0<sf.count}),this.initTargets(flows))},initTargets:function(act){for(var a=this._targets,n=a.length,m=act?act.length:0,i=0;i<m;++i)a[i]=act[i];for(;i<n&&null!=a[i];++i)a[i]=null;a.active=m},transform:function(_,pulse){var $jscomp$this=this,df=pulse.dataflow,key$jscomp$0=_.key,flow=_.subflow,cache=this._keys,rekey=_.modified("key"),subflow=function(key){return $jscomp$this.subflow(key,flow,pulse)};this._group=_.group||{};this.initTargets();pulse.visit(pulse.REM,
function(t){var id=vegaDataflow.tupleid(t),k=cache.get(id);void 0!==k&&(cache.delete(id),subflow(k).rem(t))});pulse.visit(pulse.ADD,function(t){var k=key$jscomp$0(t);cache.set(vegaDataflow.tupleid(t),k);subflow(k).add(t)});rekey||pulse.modified(key$jscomp$0.fields)?pulse.visit(pulse.MOD,function(t){var id=vegaDataflow.tupleid(t),k0=cache.get(id),k1=key$jscomp$0(t);k0===k1?subflow(k1).mod(t):(cache.set(id,k1),subflow(k0).rem(t),subflow(k1).add(t))}):pulse.changed(pulse.MOD)&&pulse.visit(pulse.MOD,
function(t){subflow(cache.get(vegaDataflow.tupleid(t))).mod(t)});rekey&&pulse.visit(pulse.REFLOW,function(t){var id=vegaDataflow.tupleid(t),k0=cache.get(id),k1=key$jscomp$0(t);k0!==k1&&(cache.set(id,k1),subflow(k0).rem(t),subflow(k1).add(t))});pulse.clean()?df.runAfter(function(){$jscomp$this.clean();cache.clean()}):cache.empty>df.cleanThreshold&&df.runAfter(cache.clean);return pulse}});vegaUtil.inherits(Field,vegaDataflow.Operator);Filter.Definition={type:"Filter",metadata:{changes:!0},params:[{name:"expr",
type:"expr",required:!0}]};vegaUtil.inherits(Filter,vegaDataflow.Transform,{transform:function(_,pulse){function revisit(t){var id=vegaDataflow.tupleid(t),b=test(t,_),s=cache.get(id);b&&s?(cache.delete(id),add.push(t)):b||s?isMod&&b&&!s&&mod.push(t):(cache.set(id,1),rem.push(t))}var df=pulse.dataflow,cache=this.value,output=pulse.fork(),add=output.add,rem=output.rem,mod=output.mod,test=_.expr,isMod=!0;pulse.visit(pulse.REM,function(t){var id=vegaDataflow.tupleid(t);cache.has(id)?cache.delete(id):
rem.push(t)});pulse.visit(pulse.ADD,function(t){test(t,_)?add.push(t):cache.set(vegaDataflow.tupleid(t),1)});pulse.visit(pulse.MOD,revisit);_.modified()&&(isMod=!1,pulse.visit(pulse.REFLOW,revisit));cache.empty>df.cleanThreshold&&df.runAfter(cache.clean);return output}});Flatten.Definition={type:"Flatten",metadata:{generates:!0},params:[{name:"fields",type:"field",array:!0,required:!0},{name:"index",type:"string"},{name:"as",type:"string",array:!0}]};vegaUtil.inherits(Flatten,vegaDataflow.Transform,
{transform:function(_,pulse){var out=pulse.fork(pulse.NO_SOURCE),fields=_.fields,as=fieldNames(fields,_.as||[]),index=_.index||null,m=as.length;out.rem=this.value;pulse.visit(pulse.SOURCE,function(t){for(var arrays=fields.map(function(f){return f(t)}),maxlen=arrays.reduce(function(l,a){return Math.max(l,a.length)},0),i=0,j,d,v;i<maxlen;++i){d=vegaDataflow.derive(t);for(j=0;j<m;++j)d[as[j]]=null==(v=arrays[j][i])?null:v;index&&(d[index]=i);out.add.push(d)}});this.value=out.source=out.add;index&&out.modifies(index);
return out.modifies(as)}});Fold.Definition={type:"Fold",metadata:{generates:!0},params:[{name:"fields",type:"field",array:!0,required:!0},{name:"as",type:"string",array:!0,length:2,"default":["key","value"]}]};vegaUtil.inherits(Fold,vegaDataflow.Transform,{transform:function(_,pulse){var out=pulse.fork(pulse.NO_SOURCE),fields=_.fields,fnames=fields.map(vegaUtil.accessorName);_=_.as||["key","value"];var k=_[0],v=_[1],n=fields.length;out.rem=this.value;pulse.visit(pulse.SOURCE,function(t){for(var i=
0,d;i<n;++i)d=vegaDataflow.derive(t),d[k]=fnames[i],d[v]=fields[i](t),out.add.push(d)});this.value=out.source=out.add;return out.modifies(_)}});Formula.Definition={type:"Formula",metadata:{modifies:!0},params:[{name:"expr",type:"expr",required:!0},{name:"as",type:"string",required:!0},{name:"initonly",type:"boolean"}]};vegaUtil.inherits(Formula,vegaDataflow.Transform,{transform:function(_,pulse){var func=_.expr,as=_.as,mod=_.modified(),flag=_.initonly?pulse.ADD:mod?pulse.SOURCE:pulse.modified(func.fields)||
pulse.modified(as)?pulse.ADD_MOD:pulse.ADD;mod&&(pulse=pulse.materialize().reflow(!0));_.initonly||pulse.modifies(as);return pulse.visit(flag,function(t){return t[as]=func(t,_)})}});vegaUtil.inherits(Generate,vegaDataflow.Transform,{transform:function(_,pulse){pulse=pulse.fork(pulse.ALL);var gen=_.generator,data=this.value,num=_.size-data.length,add,t;if(0<num){for(add=[];0<=--num;)add.push(t=vegaDataflow.ingest(gen(_))),data.push(t);pulse.add=pulse.add.length?pulse.materialize(pulse.ADD).add.concat(add):
add}else _=data.slice(0,-num),pulse.rem=pulse.rem.length?pulse.materialize(pulse.REM).rem.concat(_):_,data=data.slice(-num);pulse.source=this.value=data;return pulse}});var Methods={value:"value",median:d3Array.median,mean:d3Array.mean,min:d3Array.min,max:d3Array.max},Empty=[];Impute.Definition={type:"Impute",metadata:{changes:!0},params:[{name:"field",type:"field",required:!0},{name:"key",type:"field",required:!0},{name:"keyvals",array:!0},{name:"groupby",type:"field",array:!0},{name:"method",type:"enum",
"default":"value",values:["value","mean","median","max","min"]},{name:"value","default":0}]};vegaUtil.inherits(Impute,vegaDataflow.Transform,{transform:function(_,pulse){var out=pulse.fork(pulse.ALL),impute=getValue(_),field=getField(_),fName=vegaUtil.accessorName(_.field),kName=vegaUtil.accessorName(_.key),gNames=(_.groupby||[]).map(vegaUtil.accessorName);_=partition(pulse.source,_.groupby,_.key,_.keyvals);pulse=[];var prev=this.value,m=_.domain.length,j,l,n;var g=0;for(l=_.length;g<l;++g){var group=
_[g];var gVals=group.values;var value=NaN;for(j=0;j<m;++j)if(null==group[j]){var kVal=_.domain[j];var t={_impute:!0};var i=0;for(n=gVals.length;i<n;++i)t[gNames[i]]=gVals[i];t[kName]=kVal;t[fName]=Number.isNaN(value)?value=impute(group,field):value;pulse.push(vegaDataflow.ingest(t))}}pulse.length&&(out.add=out.materialize(out.ADD).add.concat(pulse));prev.length&&(out.rem=out.materialize(out.REM).rem.concat(prev));this.value=pulse;return out}});JoinAggregate.Definition={type:"JoinAggregate",metadata:{modifies:!0},
params:[{name:"groupby",type:"field",array:!0},{name:"fields",type:"field","null":!0,array:!0},{name:"ops",type:"enum",array:!0,values:noop},{name:"as",type:"string","null":!0,array:!0},{name:"key",type:"field"}]};vegaUtil.inherits(JoinAggregate,Aggregate,{transform:function(_,pulse){var aggr=this,mod=_.modified();if(aggr.value&&(mod||pulse.modified(aggr._inputs,!0))){var cells=aggr.value=mod?aggr.init(_):{};pulse.visit(pulse.SOURCE,function(t){return aggr.add(t)})}else cells=aggr.value=aggr.value||
this.init(_),pulse.visit(pulse.REM,function(t){return aggr.rem(t)}),pulse.visit(pulse.ADD,function(t){return aggr.add(t)});aggr.changes();pulse.visit(pulse.SOURCE,function(t){vegaUtil.extend(t,cells[aggr.cellkey(t)].tuple)});return pulse.reflow(mod).modifies(this._outputs)},changes:function(){var adds=this._adds,mods=this._mods,n;var i=0;for(n=this._alen;i<n;++i)this.celltuple(adds[i]),adds[i]=null;i=0;for(n=this._mlen;i<n;++i)this.celltuple(mods[i]),mods[i]=null;this._alen=this._mlen=0}});KDE.Definition=
{type:"KDE",metadata:{generates:!0},params:[{name:"groupby",type:"field",array:!0},{name:"field",type:"field",required:!0},{name:"cumulative",type:"boolean","default":!1},{name:"counts",type:"boolean","default":!1},{name:"bandwidth",type:"number","default":0},{name:"extent",type:"number",array:!0,length:2},{name:"resolve",type:"enum",values:["shared","independent"],"default":"independent"},{name:"steps",type:"number"},{name:"minsteps",type:"number","default":25},{name:"maxsteps",type:"number","default":200},
{name:"as",type:"string",array:!0,"default":["value","density"]}]};vegaUtil.inherits(KDE,vegaDataflow.Transform,{transform:function(_,pulse){var out=pulse.fork(pulse.NO_SOURCE|pulse.NO_FIELDS);if(!this.value||pulse.changed()||_.modified()){pulse=pulse.materialize(pulse.SOURCE).source;var groups=partition$1(pulse,_.groupby,_.field),names=(_.groupby||[]).map(vegaUtil.accessorName),bandwidth=_.bandwidth,method=_.cumulative?"cdf":"pdf",as=_.as||["value","density"],values=[],domain=_.extent,minsteps=_.steps||
_.minsteps||25,maxsteps=_.steps||_.maxsteps||200;"pdf"!==method&&"cdf"!==method&&vegaUtil.error("Invalid density method: "+method);"shared"===_.resolve&&(domain||(domain=vegaUtil.extent(pulse,_.field)),minsteps=maxsteps=_.steps||maxsteps);groups.forEach(function(g){var density=vegaStatistics.randomKDE(g,bandwidth)[method],scale=_.counts?g.length:1,local=domain||vegaUtil.extent(g);vegaStatistics.sampleCurve(density,local,minsteps,maxsteps).forEach(function(v){for(var t={},i=0;i<names.length;++i)t[names[i]]=
g.dims[i];t[as[0]]=v[0];t[as[1]]=v[1]*scale;values.push(vegaDataflow.ingest(t))})});this.value&&(out.rem=this.value);this.value=out.add=out.source=values}return out}});vegaUtil.inherits(Key,vegaDataflow.Operator);vegaUtil.inherits(Load,vegaDataflow.Transform,{transform:function(_,pulse){var $jscomp$this=this,df$jscomp$0=pulse.dataflow;return this._pending?output$jscomp$0(this,pulse,this._pending):stop$jscomp$0(_)?pulse.StopPropagation:_.values?output$jscomp$0(this,pulse,df$jscomp$0.parse(_.values,
_.format)):_.async?{async:df$jscomp$0.request(_.url,_.format).then(function(res){$jscomp$this._pending=vegaUtil.array(res.data);return function(df){return df.touch($jscomp$this)}})}:df$jscomp$0.request(_.url,_.format).then(function(res){return output$jscomp$0($jscomp$this,pulse,vegaUtil.array(res.data))})}});Lookup.Definition={type:"Lookup",metadata:{modifies:!0},params:[{name:"index",type:"index",params:[{name:"from",type:"data",required:!0},{name:"key",type:"field",required:!0}]},{name:"values",
type:"field",array:!0},{name:"fields",type:"field",array:!0,required:!0},{name:"as",type:"string",array:!0},{name:"default","default":null}]};vegaUtil.inherits(Lookup,vegaDataflow.Transform,{transform:function(_,pulse){var keys=_.fields,index=_.index,values=_.values,defaultValue=null==_.default?null:_.default,reset=_.modified(),n=keys.length,flag=reset?pulse.SOURCE:pulse.ADD,out=pulse,as=_.as;if(values){var m=values.length;1<n&&!as&&vegaUtil.error('Multi-field lookup requires explicit "as" parameter.');
as&&as.length!==n*m&&vegaUtil.error('The "as" parameter has too few output field names.');as=as||values.map(vegaUtil.accessorName);_=function(t){for(var i=0,k=0,j,v;i<n;++i)if(v=index.get(keys[i](t)),null==v)for(j=0;j<m;++j,++k)t[as[k]]=defaultValue;else for(j=0;j<m;++j,++k)t[as[k]]=values[j](v)}}else as||vegaUtil.error("Missing output field names."),_=function(t){for(var i=0,v;i<n;++i)v=index.get(keys[i](t)),t[as[i]]=null==v?defaultValue:v};reset?out=pulse.reflow(!0):(reset=keys.some(function(k){return pulse.modified(k.fields)}),
flag|=reset?pulse.MOD:0);pulse.visit(flag,_);return out.modifies(as)}});vegaUtil.inherits(MultiExtent,vegaDataflow.Operator);vegaUtil.inherits(MultiValues,vegaDataflow.Operator);vegaUtil.inherits(Params,vegaDataflow.Transform,{transform:function(_,pulse){this.modified(_.modified());this.value=_;return pulse.fork(pulse.NO_SOURCE|pulse.NO_FIELDS)}});Pivot.Definition={type:"Pivot",metadata:{generates:!0,changes:!0},params:[{name:"groupby",type:"field",array:!0},{name:"field",type:"field",required:!0},
{name:"value",type:"field",required:!0},{name:"op",type:"enum",values:noop,"default":"sum"},{name:"limit",type:"number","default":0},{name:"key",type:"field"}]};vegaUtil.inherits(Pivot,Aggregate,{_transform:Aggregate.prototype.transform,transform:function(_,pulse){return this._transform(aggregateParams(_,pulse),pulse)}});vegaUtil.inherits(PreFacet,Facet,{transform:function(_$jscomp$0,pulse){var $jscomp$this=this,flow=_$jscomp$0.subflow,field=_$jscomp$0.field,subflow=function(t){return $jscomp$this.subflow(vegaDataflow.tupleid(t),
flow,pulse,t)};(_$jscomp$0.modified("field")||field&&pulse.modified(vegaUtil.accessorFields(field)))&&vegaUtil.error("PreFacet does not support field modification.");this.initTargets();field?(pulse.visit(pulse.MOD,function(t){var sf=subflow(t);field(t).forEach(function(_){return sf.mod(_)})}),pulse.visit(pulse.ADD,function(t){var sf=subflow(t);field(t).forEach(function(_){return sf.add(vegaDataflow.ingest(_))})}),pulse.visit(pulse.REM,function(t){var sf=subflow(t);field(t).forEach(function(_){return sf.rem(_)})})):
(pulse.visit(pulse.MOD,function(t){return subflow(t).mod(t)}),pulse.visit(pulse.ADD,function(t){return subflow(t).add(t)}),pulse.visit(pulse.REM,function(t){return subflow(t).rem(t)}));pulse.clean()&&pulse.runAfter(function(){return $jscomp$this.clean()});return pulse}});Project.Definition={type:"Project",metadata:{generates:!0,changes:!0},params:[{name:"fields",type:"field",array:!0},{name:"as",type:"string","null":!0,array:!0}]};vegaUtil.inherits(Project,vegaDataflow.Transform,{transform:function(_,
pulse){var out=pulse.fork(pulse.NO_SOURCE),fields=_.fields,as=fieldNames(_.fields,_.as||[]),derive=fields?function(s,t){for(var i=0,n=fields.length;i<n;++i)t[as[i]]=fields[i](s);return t}:vegaDataflow.rederive;if(this.value)var lut=this.value;else pulse=pulse.addAll(),lut=this.value={};pulse.visit(pulse.REM,function(t){t=vegaDataflow.tupleid(t);out.rem.push(lut[t]);lut[t]=null});pulse.visit(pulse.ADD,function(t){var dt=derive(t,vegaDataflow.ingest({}));lut[vegaDataflow.tupleid(t)]=dt;out.add.push(dt)});
pulse.visit(pulse.MOD,function(t){out.mod.push(derive(t,lut[vegaDataflow.tupleid(t)]))});return out}});vegaUtil.inherits(Proxy,vegaDataflow.Transform,{transform:function(_,pulse){this.value=_.value;return _.modified("value")?pulse.fork(pulse.NO_SOURCE|pulse.NO_FIELDS):pulse.StopPropagation}});Quantile.Definition={type:"Quantile",metadata:{generates:!0,changes:!0},params:[{name:"groupby",type:"field",array:!0},{name:"field",type:"field",required:!0},{name:"probs",type:"number",array:!0},{name:"step",
type:"number","default":.01},{name:"as",type:"string",array:!0,"default":["prob","value"]}]};vegaUtil.inherits(Quantile,vegaDataflow.Transform,{transform:function(_,pulse){var out=pulse.fork(pulse.NO_SOURCE|pulse.NO_FIELDS),as=_.as||["prob","value"];if(this.value&&!_.modified()&&!pulse.changed())return out.source=this.value,out;pulse=pulse.materialize(pulse.SOURCE).source;pulse=partition$1(pulse,_.groupby,_.field);var names=(_.groupby||[]).map(vegaUtil.accessorName),values=[],step=_.step||.01,p=_.probs||
d3Array.range(step/2,1-1E-14,step),n=p.length;pulse.forEach(function(g){for(var q=vegaStatistics.quantiles(g,p),i=0;i<n;++i){for(var t={},i$663=0;i$663<names.length;++i$663)t[names[i$663]]=g.dims[i$663];t[as[0]]=p[i];t[as[1]]=q[i];values.push(vegaDataflow.ingest(t))}});this.value&&(out.rem=this.value);this.value=out.add=out.source=values;return out}});vegaUtil.inherits(Relay,vegaDataflow.Transform,{transform:function(_,pulse){if(this.value)var lut=this.value;else{var out=pulse=pulse.addAll();lut=
this.value={}}_.derive&&(out=pulse.fork(pulse.NO_SOURCE),pulse.visit(pulse.REM,function(t){t=vegaDataflow.tupleid(t);out.rem.push(lut[t]);lut[t]=null}),pulse.visit(pulse.ADD,function(t){var dt=vegaDataflow.derive(t);lut[vegaDataflow.tupleid(t)]=dt;out.add.push(dt)}),pulse.visit(pulse.MOD,function(t){var dt=lut[vegaDataflow.tupleid(t)],k;for(k in t)dt[k]=t[k],out.modifies(k);out.mod.push(dt)}));return out}});Sample.Definition={type:"Sample",metadata:{},params:[{name:"size",type:"number","default":1E3}]};
vegaUtil.inherits(Sample,vegaDataflow.Transform,{transform:function(_,pulse){function update(t){if(res.length<num)res.push(t);else{var idx=~~((cnt+1)*vegaStatistics.random());if(idx<res.length&&idx>=cap){var p=res[idx];map[vegaDataflow.tupleid(p)]&&out.rem.push(p);res[idx]=t}}++cnt}var out=pulse.fork(pulse.NO_SOURCE),mod=_.modified("size"),num=_.size,map=this.value.reduce(function(m,t){return m[vegaDataflow.tupleid(t)]=1,m},{}),res=this.value,cnt=this.count,cap=0;pulse.rem.length&&(pulse.visit(pulse.REM,
function(t){var id=vegaDataflow.tupleid(t);map[id]&&(map[id]=-1,out.rem.push(t));--cnt}),res=res.filter(function(t){return-1!==map[vegaDataflow.tupleid(t)]}));(pulse.rem.length||mod)&&res.length<num&&pulse.source&&(cap=cnt=res.length,pulse.visit(pulse.SOURCE,function(t){map[vegaDataflow.tupleid(t)]||update(t)}),cap=-1);if(mod&&res.length>num){_=res.length-num;for(mod=0;mod<_;++mod)map[vegaDataflow.tupleid(res[mod])]=-1,out.rem.push(res[mod]);res=res.slice(_)}pulse.mod.length&&pulse.visit(pulse.MOD,
function(t){map[vegaDataflow.tupleid(t)]&&out.mod.push(t)});pulse.add.length&&pulse.visit(pulse.ADD,update);if(pulse.add.length||0>cap)out.add=res.filter(function(t){return!map[vegaDataflow.tupleid(t)]});this.count=cnt;this.value=out.source=res;return out}});Sequence.Definition={type:"Sequence",metadata:{generates:!0,changes:!0},params:[{name:"start",type:"number",required:!0},{name:"stop",type:"number",required:!0},{name:"step",type:"number","default":1},{name:"as",type:"string","default":"data"}]};
vegaUtil.inherits(Sequence,vegaDataflow.Transform,{transform:function(_,pulse){if(!this.value||_.modified()){var out=pulse.materialize().fork(pulse.MOD),as=_.as||"data";out.rem=this.value?pulse.rem.concat(this.value):pulse.rem;this.value=d3Array.range(_.start,_.stop,_.step||1).map(function(v){var t={};t[as]=v;return vegaDataflow.ingest(t)});out.add=pulse.add.concat(this.value);return out}}});vegaUtil.inherits(Sieve,vegaDataflow.Transform,{transform:function(_,pulse){this.value=pulse.source;return pulse.changed()?
pulse.fork(pulse.NO_SOURCE|pulse.NO_FIELDS):pulse.StopPropagation}});var OUTPUT=["unit0","unit1"];TimeUnit.Definition={type:"TimeUnit",metadata:{modifies:!0},params:[{name:"field",type:"field",required:!0},{name:"interval",type:"boolean","default":!0},{name:"units",type:"enum",values:vegaTime.TIME_UNITS,array:!0},{name:"step",type:"number","default":1},{name:"maxbins",type:"number","default":40},{name:"extent",type:"date",array:!0},{name:"timezone",type:"enum","default":"local",values:["local","utc"]},
{name:"as",type:"string",array:!0,length:2,"default":OUTPUT}]};vegaUtil.inherits(TimeUnit,vegaDataflow.Transform,{transform:function(_,pulse){var field=_.field,band=!1!==_.interval,utc="utc"===_.timezone,floor=this._floor(_,pulse),offset=(utc?vegaTime.utcInterval:vegaTime.timeInterval)(floor.unit).offset;utc=_.as||OUTPUT;var u0=utc[0],u1=utc[1],step=floor.step,min=floor.start||Infinity,max=floor.stop||-Infinity,flag=pulse.ADD;if(_.modified()||pulse.modified(vegaUtil.accessorFields(field)))pulse=pulse.reflow(!0),
flag=pulse.SOURCE,min=Infinity,max=-Infinity;pulse.visit(flag,function(t){var v=field(t),b;null==v?(t[u0]=null,band&&(t[u1]=null)):(t[u0]=v=b=floor(v),band&&(t[u1]=b=offset(v,step)),v<min&&(min=v),b>max&&(max=b))});floor.start=min;floor.stop=max;return pulse.modifies(band?utc:u0)},_floor:function(_,pulse){var utc="utc"===_.timezone;pulse=_.units?{units:_.units,step:_.step||1}:vegaTime.timeBin({extent:_.extent||vegaUtil.extent(pulse.materialize(pulse.SOURCE).source,_.field),maxbins:_.maxbins});_=pulse.step;
pulse=vegaTime.timeUnits(pulse.units);var prev=this.value||{};utc=(utc?vegaTime.utcFloor:vegaTime.timeFloor)(pulse,_);utc.unit=vegaUtil.peek(pulse);utc.units=pulse;utc.step=_;utc.start=prev.start;utc.stop=prev.stop;return this.value=utc}});vegaUtil.inherits(TupleIndex,vegaDataflow.Transform,{transform:function(_,pulse){var df=pulse.dataflow,field=_.field,index=this.value,set=function(t){return index.set(field(t),t)},mod=!0;_.modified("field")||pulse.modified(field.fields)?(index.clear(),pulse.visit(pulse.SOURCE,
set)):pulse.changed()?(pulse.visit(pulse.REM,function(t){return index.delete(field(t))}),pulse.visit(pulse.ADD,set)):mod=!1;this.modified(mod);index.empty>df.cleanThreshold&&df.runAfter(index.clean);return pulse.fork()}});vegaUtil.inherits(Values,vegaDataflow.Transform,{transform:function(_,pulse){if(!this.value||_.modified("field")||_.modified("sort")||pulse.changed()||_.sort&&pulse.modified(_.sort.fields))this.value=(_.sort?pulse.source.slice().sort(vegaDataflow.stableCompare(_.sort)):pulse.source).map(_.field)}});
var WindowOps={row_number:function(){return{next:function(w){return w.index+1}}},rank:function(){var rank;return{init:function(){return rank=1},next:function(w){var i=w.index,data=w.data;return i&&w.compare(data[i-1],data[i])?rank=i+1:rank}}},dense_rank:function(){var drank;return{init:function(){return drank=1},next:function(w){var i=w.index,d=w.data;return i&&w.compare(d[i-1],d[i])?++drank:drank}}},percent_rank:function(){var rank=WindowOps.rank(),next=rank.next;return{init:rank.init,next:function(w){return(next(w)-
1)/(w.data.length-1)}}},cume_dist:function(){var cume;return{init:function(){return cume=0},next:function(w){var d=w.data,c=w.compare;w=w.index;if(cume<w){for(;w+1<d.length&&!c(d[w],d[w+1]);)++w;cume=w}return(1+cume)/d.length}}},ntile:function(field,num){num=+num;0<num||vegaUtil.error("ntile num must be greater than zero.");field=WindowOps.cume_dist();var next=field.next;return{init:field.init,next:function(w){return Math.ceil(num*next(w))}}},lag:function(field,offset){offset=+offset||1;return{next:function(w){var i=
w.index-offset;return 0<=i?field(w.data[i]):null}}},lead:function(field,offset){offset=+offset||1;return{next:function(w){var i=w.index+offset;w=w.data;return i<w.length?field(w[i]):null}}},first_value:function(field){return{next:function(w){return field(w.data[w.i0])}}},last_value:function(field){return{next:function(w){return field(w.data[w.i1-1])}}},nth_value:function(field,nth){nth=+nth;0<nth||vegaUtil.error("nth_value nth must be greater than zero.");return{next:function(w){var i=w.i0+(nth-1);
return i<w.i1?field(w.data[i]):null}}},prev_value:function(field){var prev;return{init:function(){return prev=null},next:function(w){w=field(w.data[w.index]);return null!=w?prev=w:prev}}},next_value:function(field){var v,i;return{init:function(){return v=null,i=-1},next:function(w){var d=w.data;if(w.index<=i)d=v;else{a:{w=w.index;for(var n=d.length;w<n;++w)if(null!=field(d[w]))break a;w=-1}d=0>(i=w)?(i=d.length,v=null):v=field(d[i])}return d}}}};prototype$1=Object.keys(WindowOps);var prototype=WindowState.prototype;
prototype.init=function(){this.windows.forEach(function(_){return _.init()});this.cell&&this.cell.init()};prototype.update=function(w,t){var cell=this.cell,wind=this.windows,data=w.data,m=wind&&wind.length,j;if(cell){for(j=w.p0;j<w.i0;++j)cell.rem(data[j]);for(j=w.p1;j<w.i1;++j)cell.add(data[j]);cell.set(t)}for(j=0;j<m;++j)wind[j].update(w,t)};Window.Definition={type:"Window",metadata:{modifies:!0},params:[{name:"sort",type:"compare"},{name:"groupby",type:"field",array:!0},{name:"ops",type:"enum",
array:!0,values:prototype$1.concat(noop)},{name:"params",type:"number","null":!0,array:!0},{name:"fields",type:"field","null":!0,array:!0},{name:"as",type:"string","null":!0,array:!0},{name:"frame",type:"number","null":!0,array:!0,length:2,"default":[null,0]},{name:"ignorePeers",type:"boolean","default":!1}]};vegaUtil.inherits(Window,vegaDataflow.Transform,{transform:function(_,pulse){var $jscomp$this=this;this.stamp=pulse.stamp;var mod=_.modified(),cmp=vegaDataflow.stableCompare(_.sort),key=groupkey(_.groupby),
state=this.state;if(!state||mod)state=this.state=new WindowState(_);mod||pulse.modified(state.inputs)?(this.value={},pulse.visit(pulse.SOURCE,function(t){return $jscomp$this.group(key(t)).add(t)})):(pulse.visit(pulse.REM,function(t){return $jscomp$this.group(key(t)).remove(t)}),pulse.visit(pulse.ADD,function(t){return $jscomp$this.group(key(t)).add(t)}));for(var i=0,n=this._mlen;i<n;++i)processPartition(this._mods[i],state,cmp,_);this._mlen=0;this._mods=[];return pulse.reflow(mod).modifies(state.outputs)},
group:function(key){var group=this.value[key];group||(group=this.value[key]=SortedList(vegaDataflow.tupleid),group.stamp=-1);group.stamp<this.stamp&&(group.stamp=this.stamp,this._mods[this._mlen++]=group);return group}});exports.aggregate=Aggregate;exports.bin=Bin;exports.collect=Collect;exports.compare=Compare;exports.countpattern=CountPattern;exports.cross=Cross;exports.density=Density;exports.dotbin=DotBin;exports.expression=Expression;exports.extent=Extent;exports.facet=Facet;exports.field=Field;
exports.filter=Filter;exports.flatten=Flatten;exports.fold=Fold;exports.formula=Formula;exports.generate=Generate;exports.impute=Impute;exports.joinaggregate=JoinAggregate;exports.kde=KDE;exports.key=Key;exports.load=Load;exports.lookup=Lookup;exports.multiextent=MultiExtent;exports.multivalues=MultiValues;exports.params=Params;exports.pivot=Pivot;exports.prefacet=PreFacet;exports.project=Project;exports.proxy=Proxy;exports.quantile=Quantile;exports.relay=Relay;exports.sample=Sample;exports.sequence=
Sequence;exports.sieve=Sieve;exports.subflow=Subflow;exports.timeunit=TimeUnit;exports.tupleindex=TupleIndex;exports.values=Values;exports.window=Window;Object.defineProperty(exports,"__esModule",{value:!0})})}
//# sourceMappingURL=module$node_modules$vega_transforms$build$vega_transforms.js.map
